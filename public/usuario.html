import { auth, db } from "./firebase.js";
import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const form = document.getElementById("userForm");
const btnComercio = document.getElementById("btnComercio");
const btnServicio = document.getElementById("btnServicio");

let currentUser = null;

// üîí Verificar login
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
  } else {
    window.location.href = "index.html";
  }
});

// üìù Funci√≥n para validar formulario
function validarFormulario() {
  return form.checkValidity();
}

async function guardarUsuario() {
  const userData = {
    nombre: document.getElementById("nombre").value,
    email: document.getElementById("email").value,
    telefono: document.getElementById("telefono").value,
    fechaNacimiento: document.getElementById("fechaNacimiento").value,
    pais: document.getElementById("pais").value,
    provincia: document.getElementById("provincia").value,
    localidad: document.getElementById("localidad").value,
    barrio: document.getElementById("barrio").value,
    direccion: document.getElementById("direccion").value,
    createdAt: new Date()
  };

  try {
    await setDoc(doc(db, "usuarios", currentUser.uid), userData, { merge: true });
  } catch (err) {
    console.error("Error guardando usuario:", err);
    alert("Hubo un error al guardar tus datos. Intenta de nuevo.");
  }
}

// üéØ Eventos botones
btnComercio.addEventListener("click", async () => {
  if (!validarFormulario()) {
    alert("Por favor, complet√° todos los campos requeridos antes de continuar.");
    return;
  }
  await guardarUsuario();
  window.location.href = "mi-comercio.html";
});

btnServicio.addEventListener("click", async () => {
  if (!validarFormulario()) {
    alert("Por favor, complet√° todos los campos requeridos antes de continuar.");
    return;
  }
  await guardarUsuario();
  window.location.href = "mi-servicio.html";
});
